<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">
    <changeSet failOnError="true" author="Taiwo Gboyegun" id="20240405-002">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="hts_pns_index_client_partner"/>
            </not>
        </preConditions>
        <sql>
            CREATE TABLE hts_pns_index_client_partner
            (
                id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 9223372036854775807 CACHE 1 ),
                uuid character varying NOT NULL,
                dob date,
                facility_id bigint NOT NULL,
                partner_id character varying(200),
                sex character varying,
                address character varying ,
                phone_number character varying,
                alternate_phone_number character varying,
                last_name character varying ,
                first_name character varying ,
                middle_name character varying ,
                notification_method character varying(200),
                hts_client_uuid character varying,
                intermediate_partner_violence jsonb,
                relationship_with_index_client character varying(200),
                known_hiv_positive character varying(200),
                date_partner_tested date,
                hiv_test_result character varying(200),
                archived integer NOT NULL,
                date_enrollment_on_art date,
                hts_client_information jsonb,
                contact_tracing jsonb,
                index_client_id character varying,
                accepted_pns character varying,
                offered_pns character varying,
                reason_for_decline character varying,
                other_reason_for_decline character varying,
                accepted_hts character varying,
                date_created timestamp without time zone NOT NULL,
                created_by character varying NOT NULL,
                date_modified timestamp without time zone NOT NULL,
                modified_by character varying NOT NULL,
                CONSTRAINT hts_pns_index_client_partner_pkey PRIMARY KEY (id),
                CONSTRAINT hts_client_uuid_fk FOREIGN KEY (hts_client_uuid)
                    REFERENCES hts_client (uuid) MATCH SIMPLE
                    ON UPDATE NO ACTION
                    ON DELETE NO ACTION
                    NOT VALID
            )
        </sql>
    </changeSet>

    <changeSet failOnError="true"  id="20240405-003" author="Taiwo Gboyegun">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="hts_client" columnName="offered_pns" />
            </not>
        </preConditions>
        <sql>
            ALTER TABLE hts_client ADD offered_pns character varying;
        </sql>
        <sql>
            ALTER TABLE hts_client ADD accepted_pns character varying;
        </sql>
    </changeSet>

    <changeSet failOnError="true" author="Taiwo Gboyegun" id="20240408-001">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="hts_family_index_testing"/>
            </not>
        </preConditions>
        <sql>
            CREATE TABLE hts_family_index_testing
            (
                id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 9223372036854775807 CACHE 1 ),
                uuid character varying NOT NULL,
                hts_client_uuid character varying,
                hts_client_id bigint NOT NULL,
                archived integer NOT NULL,
                extra jsonb,
                state character varying,
                lga character varying,
                facility_name character varying,
                visit_date date,
                setting character varying,
                family_index_client character varying,
                sex character varying,
                index_client_id character varying,
                name character varying,
                date_of_birth date,
                age character varying,
                marital_status character varying,
                phone_number character varying,
                alternate_phone_number character varying,
                date_index_client_confirmed_hiv_positive_test_result date,
                virally_unsurpressed character varying,
                is_client_curremtly_on_hiv_treatment character varying,
                date_client_enrolled_on_treatment character varying,
                recency_testing character varying,
                willing_to_have_children_tested_else_where character varying,
                date_created timestamp without time zone NOT NULL,
                created_by character varying NOT NULL,
                date_modified timestamp without time zone NOT NULL,
                modified_by character varying NOT NULL,
                CONSTRAINT hts_family_index_testing_pkey PRIMARY KEY (id),
                CONSTRAINT hts_client_uuid_fk FOREIGN KEY (hts_client_uuid)
                    REFERENCES hts_client (uuid) MATCH SIMPLE
                    ON UPDATE NO ACTION
                    ON DELETE NO ACTION
                    NOT VALID,
                CONSTRAINT unique_uuid UNIQUE (uuid)
            )
        </sql>
    </changeSet>

    <changeSet failOnError="true" author="Taiwo Gboyegun" id="202404010-004">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="hts_family_index"/>
            </not>
        </preConditions>
        <sql>
            CREATE TABLE hts_family_index
            (
                id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 9223372036854775807 CACHE 1 ),
                uuid character varying NOT NULL UNIQUE,
                archived integer NOT NULL,
                family_relationship character varying,
                status_of_contact character varying,
                child_number integer,
                mother_dead character varying,
                year_mother_dead date,
                child_Dead character varying,
                year_child_dead date,
                date_of_hts date,
                first_name character varying,
                last_name character varying,
                middle_name character varying,
                date_of_birth date,
                age integer,
                is_date_of_birth_estimated boolean,
                live_with_parent character varying,
                family_index_testing_id bigint,
                family_index_testing_uuid character varying,
                uan character varying,
                date_created timestamp without time zone NOT NULL,
                created_by character varying NOT NULL,
                date_modified timestamp without time zone NOT NULL,
                modified_by character varying NOT NULL,
                CONSTRAINT hts_family_index_pkey PRIMARY KEY (id),
                CONSTRAINT family_index_testing_uuid_fk FOREIGN KEY (family_index_testing_uuid)
                    REFERENCES hts_family_index_testing (uuid) MATCH SIMPLE
                    ON UPDATE NO ACTION
                    ON DELETE NO ACTION
                    NOT VALID
            )
        </sql>
    </changeSet>

    <changeSet failOnError="true" author="Taiwo Gboyegun" id="20240405-004">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="hts_family_index_testing_tracker"/>
            </not>
        </preConditions>
        <sql>
            CREATE TABLE hts_family_index_testing_tracker
            (
                id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 9223372036854775807 CACHE 1 ),
                uuid character varying NOT NULL,
                archived integer NOT NULL,
                position_of_child_enumerated integer,
                tracker_sex character varying,
                tracker_age integer,
                schedule_visit_date date,
                follow_up_appointment_location character varying,
                date_visit date,
                known_hiv_positive character varying,
                hiv_test_result character varying,
                date_tested date,
                date_enrolledOnArt date,
                date_enrolled_in_ovc date,
                ovc_id character varying,
                facility_id bigint NOT NULL,
                family_index_id bigint NOT NULL,
                family_index_uuid character varying,
                attempts jsonb,
                date_created timestamp without time zone NOT NULL,
                created_by character varying NOT NULL,
                date_modified timestamp without time zone NOT NULL,
                modified_by character varying NOT NULL,
                CONSTRAINT hts_family_index_testing_tracker_pkey PRIMARY KEY (id),
                CONSTRAINT family_index_id_fk FOREIGN KEY (family_index_id)
                    REFERENCES hts_family_index (id) MATCH SIMPLE
                    ON UPDATE NO ACTION
                    ON DELETE NO ACTION
                    NOT VALID,
                CONSTRAINT family_index_uuid_fk FOREIGN KEY (family_index_uuid)
                    REFERENCES hts_family_index (uuid) MATCH SIMPLE
                    ON UPDATE NO ACTION
                    ON DELETE NO ACTION
                    NOT VALID
            )
        </sql>
    </changeSet>



    <changeSet failOnError="true" author="Taiwo Gboyegun" id="202404011-001">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="hts_client_referral"/>
            </not>
        </preConditions>
        <sql>
            CREATE TABLE hts_client_referral
            (
                id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 9223372036854775807 CACHE 1 ),
                date_visit DATE,
                uuid VARCHAR(255),
                hts_client_id BIGINT NOT NULL,
                hts_client_uuid VARCHAR(255),
                referred_from_facility VARCHAR(255),
                receiving_facility_state_name VARCHAR(255),
                receiving_facility_lga_name VARCHAR(255),
                name_of_person_referring_client VARCHAR(255),
                name_of_referring_facility VARCHAR(255),
                address_of_referring_facility VARCHAR(255),
                phone_no_of_referring_facility VARCHAR(255),
                referred_to VARCHAR(255),
                name_of_contact_person VARCHAR(255),
                name_of_reciving_facility VARCHAR(255),
                address_of_receiving_facility VARCHAR(255),
                phone_no_of_receiving_facility VARCHAR(255),
                service_needed JSONB,
                comments VARCHAR(255),
                receiving_organization JSONB,
                archived integer NOT NULL,
                date_created timestamp without time zone NOT NULL,
                created_by character varying NOT NULL,
                date_modified timestamp without time zone NOT NULL,
                modified_by character varying NOT NULL,
                CONSTRAINT hts_client_referral_pkey PRIMARY KEY (id),
                CONSTRAINT hts_client_referral_hts_client_id_fk FOREIGN KEY (hts_client_id) REFERENCES hts_client (id)
                    MATCH SIMPLE
                    ON UPDATE NO ACTION
                    ON DELETE NO ACTION
                    NOT VALID
            )
        </sql>
    </changeSet>

    <changeSet failOnError="true" author="Ganiyat" id="20240703-001">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="hts_pns_index_client_partner" columnName="reason_for_decline" />

            </not>
        </preConditions>
        <sql>ALTER TABLE hts_pns_index_client_partner ADD reason_for_decline VARCHAR(255);</sql>
    </changeSet>
    <changeSet failOnError="true" author="Ganiyat" id="20240703-0023">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="hts_pns_index_client_partner" columnName="other_reason_for_decline" />

            </not>
        </preConditions>
        <sql>ALTER TABLE hts_pns_index_client_partner ADD other_reason_for_decline VARCHAR(255);</sql>
    </changeSet>



    <changeSet failOnError="true" author="Ganiyat" id="20240703-033">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="hts_pns_index_client_partner" columnName="partner_id" />
            </not>
        </preConditions>
        <sql>ALTER TABLE hts_pns_index_client_partner ADD partner_id VARCHAR(255);</sql>
    </changeSet>

    <changeSet failOnError="true" author="Taiwo Gboyegun" id="20240902-002-2">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="hts_family_index_testing_tracker"/>
            <not>
                <columnExists tableName="hts_family_index_testing_tracker" columnName="family_index_testing_id" />
            </not>
        </preConditions>
        <sql>
            ALTER TABLE hts_family_index_testing_tracker
                ADD COLUMN family_index_testing_id bigint;
        </sql>
        <sql>
            ALTER TABLE hts_family_index_testing_tracker
                ADD CONSTRAINT family_index_testing_id_fk FOREIGN KEY (family_index_testing_id) REFERENCES hts_family_index_testing (id) MATCH SIMPLE ON UPDATE NO ACTION ON DELETE NO ACTION;
        </sql>
    </changeSet>
    <changeSet failOnError="false" author="Taiwo Gboyegun" id="20240909-001">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="hts_family_index" columnName="is_htsclient" />
            </not>
        </preConditions>
        <sql>
            ALTER TABLE hts_family_index ADD COLUMN is_htsclient varchar(255);
        </sql>
    </changeSet>
    <changeSet failOnError="false" author="Taiwo Gboyegun" id="isHtsClient-001">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="hts_pns_index_client_partner" columnName="is_htsclient" />
            </not>
        </preConditions>
        <sql>
            ALTER TABLE hts_pns_index_client_partner ADD COLUMN is_htsclient varchar(255);
        </sql>
    </changeSet>

    <changeSet failOnError="true" author="Ganiyat Yakub" id="20109754755-071">

        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="hts_family_index" columnName="other_child_number" />
            </not>
        </preConditions>

        <sql>
            ALTER TABLE hts_family_index ADD COLUMN other_child_number varchar(255);
        </sql>
    </changeSet>



</databaseChangeLog>